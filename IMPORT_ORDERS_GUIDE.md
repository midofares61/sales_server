# دليل استيراد الطلبات - نظام متقدم

## الميزات الجديدة 🎯

تم تحديث سكريبت `mongo-orders-to-mysql.js` ليتضمن:

### 1. **نظام البحث الذكي (Fuzzy Matching)**
يمنع تكرار المسوقين والمناديب والمنتجات عند اختلاف الأسماء بشكل بسيط.

### 2. **نظام إعادة المحاولة (Retry System)**
يعيد المحاولة تلقائياً عند انقطاع الاتصال بقاعدة البيانات.

### 3. **تخطي الطلبات الموجودة (Skip Existing)**
يتخطى الطلبات التي تم استيرادها مسبقاً ويكمل من حيث توقف.

### 4. **تقارير مفصلة (Detailed Reports)**
يعرض إحصائيات كاملة عن عملية الاستيراد.

### كيف يعمل النظام الذكي؟

1. **التطبيع (Normalization)**
   - إزالة المسافات الزائدة
   - توحيد الحروف الكبيرة والصغيرة
   - تنظيف البيانات تلقائياً

2. **المقارنة الذكية (Fuzzy Matching)**
   - يقارن الأسماء بنسبة تشابه
   - إذا كان التشابه أكبر من 85%، يستخدم السجل الموجود
   - يمنع إنشاء سجلات مكررة

### أمثلة على التطابق:

| الاسم الجديد | الاسم الموجود | النتيجة |
|-------------|---------------|---------|
| "محمد علي" | "محمد  علي" (مسافة زائدة) | ✅ تطابق |
| "احمد" | "أحمد" | ✅ تطابق |
| "منتج رقم 1" | "منتج رقم1" | ✅ تطابق |
| "عبدالله" | "عبد الله" | ✅ تطابق |
| "محمد" | "أحمد" | ❌ لا تطابق (إنشاء جديد) |

## نظام إعادة المحاولة والتعامل مع الانقطاع 🔄

### ماذا يحدث عند انقطاع الاتصال؟

1. **إعادة المحاولة التلقائية**: يحاول إعادة الاتصال 3 مرات
2. **فترة انتظار**: 5 ثوانٍ بين كل محاولة
3. **تخطي الطلبات الموجودة**: عند إعادة التشغيل، يتخطى الطلبات المستوردة مسبقاً
4. **استكمال من حيث توقف**: لا يعيد استيراد نفس الطلبات مرة أخرى

### مثال على الانقطاع والاستكمال:

```bash
# التشغيل الأول (انقطع عند 7200 طلب)
📊 التقدم: 7200 / 13124 (55%)
   ✅ مستورد: 7150
   ⏭️  متخطى: 50
   ❌ أخطاء: 0
❌ خطأ في الاتصال... توقف

# إعادة التشغيل (يكمل من 7200)
📊 التقدم: 13124 / 13124 (100%)
   ✅ مستورد: 5924  (الجديدة فقط)
   ⏭️  متخطى: 7200  (السابقة)
   ❌ أخطاء: 0
```

### إعدادات التحكم

يمكنك التحكم في الإعدادات من خلال ملف `.env`:

```env
# نسبة التشابه المطلوبة (0.0 إلى 1.0)
# القيمة الافتراضية: 0.85 (85%)
SIMILARITY_THRESHOLD=0.85

# عدد مرات إعادة المحاولة عند الخطأ
# القيمة الافتراضية: 3
MAX_RETRIES=3

# وقت الانتظار بين المحاولات (بالميلي ثانية)
# القيمة الافتراضية: 5000 (5 ثوانٍ)
RETRY_DELAY=5000

# حجم الدفعة (عدد الطلبات في كل دفعة)
# القيمة الافتراضية: 200
IMPORT_BATCH_SIZE=200
```

### رسائل السكريبت

عند تشغيل السكريبت، ستظهر رسائل تفصيلية:

```bash
🚀 بدء استيراد الطلبات...

✅ تم الاتصال بقاعدة البيانات بنجاح

📥 جلب الطلبات من المصدر...
✅ تم جلب 13124 طلب من المصدر

⏳ بدء الاستيراد...

📦 معالجة دفعة 1 (1 - 200)...
✓ وجدت مسوق مشابه: "محمد علي" ← "محمد  علي"
+ إنشاء مندوب جديد: "خالد أحمد"
✓ وجدت منتج مشابه: "منتج رقم 1" ← "منتج رقم1"

📊 التقدم: 200 / 13124 (2%)
   ✅ مستورد: 190
   ⏭️  متخطى: 10
   ❌ أخطاء: 0

...

═══════════════════════════════════════
🎉 تم الانتهاء من الاستيراد!
═══════════════════════════════════════
📊 الإحصائيات النهائية:
   إجمالي الطلبات: 13124
   ✅ تم استيراده: 12800
   ⏭️  تم تخطيه (موجود مسبقاً): 300
   ❌ أخطاء: 24
   ⏱️  الوقت المستغرق: 245.67 ثانية
═══════════════════════════════════════

👋 تم إغلاق الاتصال بقاعدة البيانات
```

### استخدام السكريبت

```bash
# تشغيل السكريبت
npm run import:orders

# أو مباشرة
node mongo-orders-to-mysql.js
```

## إعدادات كاملة

ملف `.env` الكامل:

```env
# إعدادات قاعدة البيانات
DB_HOST=localhost
DB_PORT=3306
DB_NAME=sales_db
DB_USER=root
DB_PASSWORD=your_password

# إعدادات API المصدر
SOURCE_BASE_URL=https://brazele.sintac.shop/api
SOURCE_TOKEN=your_token_here

# إعدادات الاستيراد
IMPORT_BATCH_SIZE=200          # حجم الدفعة
SIMILARITY_THRESHOLD=0.85       # نسبة التشابه
MAX_RETRIES=3                   # عدد المحاولات
RETRY_DELAY=5000                # وقت الانتظار (ميلي ثانية)
```

## الفوائد الرئيسية 🎁

### البحث الذكي
✅ منع تكرار المسوقين  
✅ منع تكرار المناديب  
✅ منع تكرار المنتجات  
✅ تنظيف البيانات تلقائياً  

### إدارة الأخطاء
✅ إعادة المحاولة التلقائية عند الانقطاع  
✅ تخطي الطلبات الموجودة مسبقاً  
✅ استكمال من حيث توقف  
✅ معالجة كل طلب بشكل منفصل (خطأ واحد لا يوقف العملية)  

### التقارير والمراقبة
✅ تقارير مفصلة في الوقت الفعلي  
✅ إحصائيات دقيقة عن التقدم  
✅ عرض الأخطاء بشكل واضح  
✅ قياس الوقت المستغرق  

## ملاحظات مهمة ⚠️

### آلية العمل
1. **البحث الدقيق**: يبحث أولاً عن تطابق دقيق 100%
2. **البحث الذكي**: إذا لم يجد، يبحث عن أسماء مشابهة (85% أو أكثر)
3. **الإنشاء**: فقط إذا لم يجد أي تطابق، ينشئ سجل جديد
4. **التخطي**: إذا كان الطلب موجوداً (نفس order_code)، يتم تخطيه

### نصائح للاستخدام الأمثل
- 🔹 قم بتشغيل السكريبت في وقت هدوء النظام للحصول على أفضل أداء
- 🔹 راقب الرسائل للتأكد من صحة التطابقات
- 🔹 احتفظ بنسخة احتياطية من قاعدة البيانات قبل الاستيراد
- 🔹 في حالة الانقطاع، ببساطة أعد تشغيل السكريبت - سيكمل من حيث توقف

### استكشاف الأخطاء
| المشكلة | الحل |
|---------|------|
| `ECONNRESET` | سيعيد المحاولة تلقائياً - لا داعي للقلق |
| `Duplicate order_code` | سيتم تخطي الطلب الموجود تلقائياً |
| عدد كبير من الأخطاء | تحقق من إعدادات قاعدة البيانات في `.env` |
| بطء شديد | قلل `IMPORT_BATCH_SIZE` إلى 100 أو 50 |

## الدعم والتطوير 📞

لأي استفسارات أو مشاكل، راجع:
- ملفات التوثيق في مجلد `docs/`
- سجلات الأخطاء في `logs/error.log`
- سجلات النظام في `logs/combined.log`

---

**تم التحديث:** أكتوبر 2025  
**الإصدار:** 2.0 - نظام متقدم مع البحث الذكي وإعادة المحاولة

