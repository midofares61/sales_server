# Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (Permissions System)

## ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©

Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¯Ù‚ÙŠÙ‚ ÙÙŠ Ù…Ø§ ÙŠÙ…ÙƒÙ† Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ù‡ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. ÙƒÙ„ Ø¯ÙˆØ± (Role) Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø­Ø¯Ø©.

---

## ğŸ­ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø© (Roles)

| Ø§Ù„Ø¯ÙˆØ± | Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© | Ø§Ù„ÙˆØµÙ |
|------|----------------|-------|
| `admin` | Ø§Ø¯Ù…Ù† | ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… |
| `sales` | Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ | ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª |
| `marketer` | Ù…Ø³ÙˆÙ‚ | ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ø§Øª ÙÙ‚Ø· |
| `mandobe` | Ù…Ù†Ø¯ÙˆØ¨ | ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯ÙˆØ¯Ø© Ø¬Ø¯Ø§Ù‹ |

---

## ğŸ” Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Permissions)

### ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Orders)
- `addOrder` - Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
- `editOrder` - ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯
- `removeOrder` - Ø­Ø°Ù Ø·Ù„Ø¨

### ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨ (Mandobes)
- `showMandobe` - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø¯ÙŠØ¨
- `addMandobe` - Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø¯ÙˆØ¨ Ø¬Ø¯ÙŠØ¯
- `editMandobe` - ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø¯ÙˆØ¨
- `removeMandobe` - Ø­Ø°Ù Ù…Ù†Ø¯ÙˆØ¨

### ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£ÙƒÙˆØ§Ø¯/Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Codes/Products)
- `showCode` - Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
- `addCode` - Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯
- `editCode` - ØªØ¹Ø¯ÙŠÙ„ ÙƒÙˆØ¯
- `removeCode` - Ø­Ø°Ù ÙƒÙˆØ¯

### ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø§Ø²Ù†/Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† (Stores/Suppliers)
- `showStore` - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø§Ø²Ù†
- `addStore` - Ø¥Ø¶Ø§ÙØ© Ù…Ø®Ø²Ù† Ø¬Ø¯ÙŠØ¯
- `editStore` - ØªØ¹Ø¯ÙŠÙ„ Ù…Ø®Ø²Ù†

---

## ğŸ“Š Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„ÙƒÙ„ Ø¯ÙˆØ±

### 1. Admin (Ø§Ø¯Ù…Ù†) âœ…
```json
{
  "addOrder": true,
  "editOrder": true,
  "removeOrder": true,
  "showMandobe": true,
  "addMandobe": true,
  "editMandobe": true,
  "removeMandobe": true,
  "showCode": true,
  "addCode": true,
  "editCode": true,
  "removeCode": true,
  "showStore": true,
  "addStore": true,
  "editStore": true
}
```

### 2. Sales (Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ) ğŸ“
```json
{
  "addOrder": true,
  "editOrder": true,
  "removeOrder": true,
  "showMandobe": true,
  "addMandobe": false,
  "editMandobe": false,
  "removeMandobe": false,
  "showCode": true,
  "addCode": false,
  "editCode": false,
  "removeCode": false,
  "showStore": true,
  "addStore": false,
  "editStore": false
}
```

### 3. Marketer (Ù…Ø³ÙˆÙ‚) ğŸ“±
```json
{
  "addOrder": true,
  "editOrder": false,
  "removeOrder": false,
  "showMandobe": false,
  "addMandobe": false,
  "editMandobe": false,
  "removeMandobe": false,
  "showCode": false,
  "addCode": false,
  "editCode": false,
  "removeCode": false,
  "showStore": false,
  "addStore": false,
  "editStore": false
}
```

### 4. Mandobe (Ù…Ù†Ø¯ÙˆØ¨) ğŸšš
```json
{
  "addOrder": false,
  "editOrder": false,
  "removeOrder": false,
  "showMandobe": false,
  "addMandobe": false,
  "editMandobe": false,
  "removeMandobe": false,
  "showCode": false,
  "addCode": false,
  "editCode": false,
  "removeCode": false,
  "showStore": false,
  "addStore": false,
  "editStore": false
}
```

---

## ğŸ”„ API Endpoints

### 1. Login Response
Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:

```bash
POST /api/auth/login
```

**Response:**
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGc...",
    "refreshToken": "eyJhbGc...",
    "user": {
      "id": 1,
      "name": "Admin",
      "username": "admin",
      "role": "admin",
      "roleNameArabic": "Ø§Ø¯Ù…Ù†",
      "permissions": {
        "addOrder": true,
        "editOrder": true,
        "removeOrder": true,
        ...
      }
    }
  }
}
```

### 2. Get All Roles and Permissions
```bash
GET /api/users/roles
Authorization: Bearer <admin_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "roles": [
      {
        "role": "admin",
        "roleNameArabic": "Ø§Ø¯Ù…Ù†",
        "permissions": { ... }
      },
      {
        "role": "sales",
        "roleNameArabic": "Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ",
        "permissions": { ... }
      },
      ...
    ]
  }
}
```

### 3. Get All Users
```bash
GET /api/users?page=1&limit=10&role=sales
Authorization: Bearer <admin_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "users": [
      {
        "id": 1,
        "name": "User Name",
        "username": "username",
        "role": "sales",
        "roleNameArabic": "Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ",
        "permissions": { ... }
      }
    ],
    "pagination": {
      "total": 10,
      "page": 1,
      "limit": 10,
      "totalPages": 1
    }
  }
}
```

### 4. Create User
```bash
POST /api/users
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "name": "New User",
  "username": "newuser",
  "phone": "01234567890",
  "password": "password123",
  "role": "sales",
  "permissions": {
    "addOrder": true,
    "editOrder": false
  }
}
```

### 5. Update User
```bash
PUT /api/users/:id
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "name": "Updated Name",
  "role": "admin"
}
```

### 6. Update User Permissions
```bash
PUT /api/users/:id/permissions
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "permissions": {
    "addOrder": true,
    "editOrder": true,
    "removeOrder": false
  }
}
```

### 7. Change User Password
```bash
PUT /api/users/:id/password
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "newPassword": "newpassword123"
}
```

### 8. Delete User
```bash
DELETE /api/users/:id
Authorization: Bearer <admin_token>
```

---

## ğŸ›¡ï¸ Middleware Usage

### ÙÙŠ Backend (Node.js):

```javascript
import { requirePermission, requireRole } from '../middleware/permissions.middleware.js';

// Require specific permission
router.post('/orders', 
  authenticate, 
  requirePermission('addOrder'), 
  createOrder
);

// Require admin role
router.delete('/users/:id', 
  authenticate, 
  requireRole('admin'), 
  deleteUser
);

// Require any of multiple permissions
router.get('/orders', 
  authenticate, 
  requireAnyPermission(['addOrder', 'editOrder']), 
  listOrders
);
```

---

## ğŸ“± Flutter Integration

### 1. User Model
```dart
class User {
  final int id;
  final String name;
  final String username;
  final String role;
  final String roleNameArabic;
  final Permissions permissions;
  
  User.fromJson(Map<String, dynamic> json)
    : id = json['id'],
      name = json['name'],
      username = json['username'],
      role = json['role'],
      roleNameArabic = json['roleNameArabic'],
      permissions = Permissions.fromJson(json['permissions']);
}

class Permissions {
  final bool? addOrder;
  final bool? editOrder;
  final bool? removeOrder;
  final bool? showMandobe;
  final bool? addMandobe;
  final bool? editMandobe;
  final bool? removeMandobe;
  final bool? showCode;
  final bool? addCode;
  final bool? editCode;
  final bool? removeCode;
  final bool? showStore;
  final bool? addStore;
  final bool? editStore;
  
  Permissions.fromJson(Map<String, dynamic> json)
    : addOrder = json['addOrder'],
      editOrder = json['editOrder'],
      removeOrder = json['removeOrder'],
      showMandobe = json['showMandobe'],
      addMandobe = json['addMandobe'],
      editMandobe = json['editMandobe'],
      removeMandobe = json['removeMandobe'],
      showCode = json['showCode'],
      addCode = json['addCode'],
      editCode = json['editCode'],
      removeCode = json['removeCode'],
      showStore = json['showStore'],
      addStore = json['addStore'],
      editStore = json['editStore'];
}
```

### 2. Check Permissions in UI
```dart
// Hide/show buttons based on permissions
if (user.permissions.addOrder == true) {
  FloatingActionButton(
    onPressed: () => navigateToAddOrder(),
    child: Icon(Icons.add),
  )
}

// Disable features
ElevatedButton(
  onPressed: user.permissions.editOrder == true 
    ? () => editOrder() 
    : null,
  child: Text('ØªØ¹Ø¯ÙŠÙ„'),
)
```

### 3. Role Selection
```dart
String? selectedRole;
Permissions? permissions;

DropdownButton<String>(
  value: selectedRole,
  items: [
    DropdownMenuItem(value: 'admin', child: Text('Ø§Ø¯Ù…Ù†')),
    DropdownMenuItem(value: 'sales', child: Text('Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ')),
    DropdownMenuItem(value: 'marketer', child: Text('Ù…Ø³ÙˆÙ‚')),
    DropdownMenuItem(value: 'mandobe', child: Text('Ù…Ù†Ø¯ÙˆØ¨')),
  ],
  onChanged: (value) {
    setState(() {
      selectedRole = value;
      // Fetch default permissions for this role from API
      fetchRolePermissions(value);
    });
  },
)
```

---

## ğŸ” Ø£Ù…Ø«Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…

### Ù…Ø«Ø§Ù„ 1: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ
```bash
POST /api/users
{
  "name": "Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯",
  "username": "mohamed",
  "password": "123456",
  "role": "sales"
}
```
Ø³ÙŠØ­ØµÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª "Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ".

### Ù…Ø«Ø§Ù„ 2: ØªØ®ØµÙŠØµ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø³ØªØ®Ø¯Ù…
```bash
PUT /api/users/5/permissions
{
  "permissions": {
    "addOrder": true,
    "editOrder": true,
    "removeOrder": true,
    "addMandobe": true
  }
}
```

### Ù…Ø«Ø§Ù„ 3: ØªØºÙŠÙŠØ± Ø¯ÙˆØ± Ù…Ø³ØªØ®Ø¯Ù…
```bash
PUT /api/users/5
{
  "role": "admin"
}
```
Ø³ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§Øª Admin Ø§Ù„ÙƒØ§Ù…Ù„Ø©.

---

## âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©

1. **Admin Bypass**: Ø¯ÙˆØ± `admin` ÙŠØªØ¬Ø§ÙˆØ² Ø¬Ù…ÙŠØ¹ ÙØ­ÙˆØµØ§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
2. **Custom Permissions**: Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ© ØªÙØ¯Ù…Ø¬ Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
3. **Null Values**: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© `null` Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ØªÙØ¹ØªØ¨Ø± `false`
4. **Security**: Ø¬Ù…ÙŠØ¹ endpoints Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØªØ·Ù„Ø¨ Ø¯ÙˆØ± `admin`

---

## ğŸ¯ Ø§Ù„Ø®Ù„Ø§ØµØ©

Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙŠÙˆÙØ±:
- âœ… **ØªØ­ÙƒÙ… Ø¯Ù‚ÙŠÙ‚** ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
- âœ… **ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©** Ù„ÙƒÙ„ Ø¯ÙˆØ±
- âœ… **ØªØ®ØµÙŠØµ Ù…Ø±Ù†** Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙØ±Ø¯ÙŠØ©
- âœ… **Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ø¯Ù…Ø¬** Ù…Ø¹ Flutter
- âœ… **Ø£Ù…Ø§Ù† Ù…Ø­ÙƒÙ…** Ù…Ø¹ middleware

**Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…! ğŸ‰**
